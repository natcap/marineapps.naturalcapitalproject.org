<html>
<head>
  <meta charset="utf-8" />
  <html lang="en">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

  <!--jQuery-->
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
  
  <!--Basic jQUery Slider
  <link rel="stylesheet" href="css/bjqs.css">
  <link rel="stylesheet" href="css/demo.css">
  <script src="js/bjqs-1.3.min.js"></script>-->
  
  <!--CartoDB and Mapbox-->
  <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
  <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.uncompressed.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.standalone.js"></script> 
  
  <!-- Leaflet Plugins -->
  <link rel="stylesheet" href="src/Control.MiniMap.css" />
  <script src="src/Control.MiniMap.js" type="text/javascript"></script> 
   <link rel="stylesheet" href="css/leaflet.draw.css"/>
  <script src="js/leaflet.draw.js"></script>
 
  <!--NAS JS Dependencies-->
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Noto+Serif:400,700,400italic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://clientwork.muledesign.com/audubon/review/css/app.css" />
 
  <!--Yellow AOI polygon-->
  <script src="src/gridCR_2500.js"></script>   

  <!--Google API-->
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>

</head>
  
<script type="text/javascript">
var collapseDivs, collapseLinks;

function createDocumentStructure (tagName) {
  if (document.getElementsByTagName) {
    var elements = document.getElementsByTagName(tagName);
    collapseDivs = new Array(elements.length);
    collapseLinks = new Array(elements.length);
    for (var i = 0; i < elements.length; i++) {
      var element = elements[i];
      var siblingContainer;
      if (document.createElement && 
          (siblingContainer = document.createElement('div')) &&
          siblingContainer.style) 
      {
        var nextSibling = element.nextSibling;
        element.parentNode.insertBefore(siblingContainer, nextSibling);
        var nextElement = elements[i + 1];
        while (nextSibling != nextElement && nextSibling != null) {
          var toMove = nextSibling;
          nextSibling = nextSibling.nextSibling;
          siblingContainer.appendChild(toMove);
        }
        siblingContainer.style.display = 'none';
        
        collapseDivs[i] = siblingContainer;
        
        createCollapseLink(element, siblingContainer, i);
      }
      else {
        // no dynamic creation of elements possible
        return;
      }
    }
    createCollapseExpandAll(elements[0]);
  }
}

function createCollapseLink (element, siblingContainer, index) {
  var span;
  if (document.createElement && (span = document.createElement('span'))) {
    span.appendChild(document.createTextNode(String.fromCharCode(160)));
    var link = document.createElement('a');
    link.collapseDiv = siblingContainer;
    link.href = '#';
    link.appendChild(document.createTextNode('[+]'));
    link.onclick = collapseExpandLink;
    collapseLinks[index] = link;
    span.appendChild(link);
    element.appendChild(span);
  }
}

function collapseExpandLink (evt) {
  if (this.collapseDiv.style.display == '') {
    this.parentNode.parentNode.nextSibling.style.display = 'none';
    this.firstChild.nodeValue = '[+]';
  }
  else {
    this.parentNode.parentNode.nextSibling.style.display = '';
    this.firstChild.nodeValue = '[-]';
  }

  if (evt && evt.preventDefault) {
    evt.preventDefault();
  }
  return false;
}

function createCollapseExpandAll (firstElement) {
  var div;
  if (document.createElement && (div = document.createElement('div'))) {
    var link = document.createElement('a');
    link.href = '#';
    link.appendChild(document.createTextNode(''));
    link.onclick = expandAll;
    div.appendChild(link);
    div.appendChild(document.createTextNode(' '));
    link = document.createElement('a');
    link.href = '#';
    link.appendChild(document.createTextNode(''));
    link.onclick = collapseAll;
    div.appendChild(link);
    firstElement.parentNode.insertBefore(div, firstElement);
  }
}

function expandAll (evt) {
  for (var i = 0; i < collapseDivs.length; i++) {
    collapseDivs[i].style.display = '';
    collapseLinks[i].firstChild.nodeValue = '[-]';
  }
  
  if (evt && evt.preventDefault) {
    evt.preventDefault();
  }
  return false;
}

function collapseAll (evt) {
  for (var i = 0; i < collapseDivs.length; i++) {
    collapseDivs[i].style.display = 'none';
    collapseLinks[i].firstChild.nodeValue = '[+]';
  }
  
  if (evt && evt.preventDefault) {
    evt.preventDefault();
  }
  return false;
}
</script>

<script type="text/javascript">
window.onload = function (evt) {
  createDocumentStructure('h4');
}
</script>  
  
  
<style type="text/css">
body{
font: 100% "Noto Serif", sans-serif;
margin: 0;
padding: 0px;
border: 0;
height: 100%;  0
max-height: 100%; 
}



#wrap { 
	width: 900px; 
	margin: 0 auto; 
}



#map { height: 600px; width: 900px; border:1px solid #000;

    #title {
      position: absolute;
      top: 25px;
      right: 150px;
      color: white;
      font-size: 27px;
      font-family: Helvetica, sans-serif;
    }

	#leaflet-draw-toolbar{
    position: relative;
    bottom: 25px;
	right: 25px;
	}
	
}

img {
    max-width: 100%;
    max-height: auto;
	margin-left:0%; margin-right:0%;
}

br {
	line-height: 100%;
}

h5 {
	line-height: 25%;
}

input[type="text"] {
    width: 250px;
}

input[type="textarea"] {
    width: 18px;
}

input[type=checkbox] {
	width: 20px;
}

.ui-slider {
    height: 15px;
    width: 300px;
	left: 30px;
}


<!-- LEVEL 1 TABLES -->
#table01 { width:100%; border:0px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse;}
#table01 td { border:0px solid #D9D5BE; vertical-align: top; width: 300px; padding: 12px;}

#table02 { width:100%; border:0px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse;}
#table02 td { border:0px solid #D9D5BE; vertical-align: top; width: 300px; padding: 10px;}

#table02b { width:100%; border:0px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse; margin-left:0%; margin-right:0%;}
#table02b td { border:0px solid #D9D5BE; vertical-align: middle; width: 300px; padding-left: 10px; padding-right: 10px;}

#table02c { width 50%; border:0px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse; margin-left:2.5%; margin-right:0%;}
#table02c td { border:0px solid #D9D5BE; vertical-align: top; width: 300px; padding: 0px;}
.cellClass { font-size:90%;}
.cellClass2 { font-size:100%;}

#table02d { width:100%; border:0px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse; margin-left:0%; margin-right:0%;}
#table02d td { border:0px solid #D9D5BE; vertical-align: top; width: 300px; padding-left: 10px; padding-right: 10px; padding-top: 25px; padding-bottom: 25px;}

#table02e { width:100%; border:0px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse; margin-left:0%; margin-right:0%;}
#table02e td { border:0px solid #D9D5BE; vertical-align: top; width: 300px; padding-left: 10px; padding-right: 0px; padding-top: 25px; padding-bottom: 25px;}

<!-- LEVEL 2 TABLES: SPECIES, LANDSCAPES & ICONS -->
#table03 { width:100%; border:1px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse;}
#table03 td { border:0px solid #D9D5BE; vertical-align: middle; width: 300px; padding: 8px;}

#table03a { width:100%; border:1px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse;}
#table03a td { border:0px solid #D9D5BE; vertical-align: middle; width: 300px; padding: 8px;}
#table03a tr:hover {background-color: rgba(0, 125, 182, 0.35);}

#table03b { width:100%; border:1px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse;}
#table03b td { border:0px solid #D9D5BE; vertical-align: middle; width: 300px; padding: 8px;}
#table03b tr:hover {background-color: rgba(255, 255, 0, 0.35);}

#table04 { width:100%; border:1px solid #D9D5BE; margin:0px; background:white; border-collapse:collapse;}
#table04 td { border:0px solid #D9D5BE; vertical-align: middle; width: 300px; padding: 8px;}





</style>

<body>

<!--
  <div id="dialog" title="ADAPTATION VIEWER TOOL">
    <div class="note">
	<p><h2>Nature-Based Strategies for Adaptation Planning</h2></p><p></p>
	Rising sea levels, population growth along coastlines and increasing hazards associated with storms threaten California's coastal communities.  Our team is engaging coastal planners, managers and the public to co-develop a multiscaled decision-support tool to highlight where natural habitats play an important role in protecting at-risk coastal populations and infrustructure.	
	<br><br>
	<div id="banner-slide">
	<ul class="bjqs">
		<li><img src="img/1.jpg" title="Rocky formation along the coast provide protection from large wave events <i>(Cape Mendocino, Mendocino County)</i>"></li>
		<li><img src="img/2.jpg" title="Small harbors provide protection for fishing fleets and increase cultural attachment to the sea <i>(Trinidad, Humboldt County)</i>"></li>
		<li><img src="img/3.jpg" title="Some areas are seeing an increase in erosion rates<br><i>(Stinson Beach, Marin County)</i>"></li>
		<li><img src="img/4.jpg" title="Revetment to protect Hwy 1 limits access to the beach and threatens to increase erosion <i>(Surfer's Beach, San Mateo County)</i>"></li>
		<li><img src="img/5.jpg" title="Built structures fail, further threatening property along the coast <i>(Gleason Beach, Sonoma County)</i>"></li>
		<li><img src="img/6.jpg" title="Dune restoration protects coastal access<br><i>(Surfer's Point, Ventura County)</i>"></li>
	</ul>
	</div>
	
    </div>
	</div>
-->

<div id="wrap">
<br>
<table>
<tr><td>

<h4><u>STEP 1</u>:<br>SELECT AREA OF INTEREST</h4> 
<div class="controlgroup">
      <select id="coasts">
        <option value="0">Select County...</option>	
		<option value="1">Sonoma</option>
		<option value="2">Marin</option>
		<option value="3">Santa Cruz - Monterey</option>
      </select>
</div>
<br>
<input type="text" name="zipcode" value="Type Zip Code + Enter..." onClick="clearZip();" onkeypress="handle(event)" id="zipcode">


</td>
<td>


<div id='test1a'></div><h4><u>STEP 2</u>:<br>ANALYTICAL STEPS</h4>



<fieldset>
<ul>


<input type="checkbox" name="steps[]" id="step1" /> <b>Hazard index</b> (relative exposure)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="exposure[]" id="state" checked /> statewide&nbsp; <input type="radio" name="exposure[]" id="county"  onclick="return false;" disabled="disabled" /> county<br>

<input type="checkbox" name="steps[]" id="step2" /> <b>Natural habitats</b><br>

<input type="checkbox" name="steps[]" id="step3" /> <b>Role of habitats</b> (relative; <input type="textarea" id="minval" style="border:0; color:#000; font-weight:bold;">th percentile)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="hab_role[]" id="combine" checked /> combine&nbsp; <input type="radio" name="hab_role[]" id="dunes"  onclick="return false;" disabled="disabled" /> dune&nbsp; <input type="radio" name="hab_role[]" id="sav"  onclick="return false;" disabled="disabled" /> SAV&nbsp; <input type="radio" name="hab_role[]" id="wetland"  onclick="return false;" disabled="disabled" /> wetland&nbsp; <input type="radio" name="hab_role[]" id="forests"  onclick="return false;" disabled="disabled" /> forest&nbsp; <input type="radio" name="hab_role[]" id="kelp"  onclick="return false;" disabled="disabled" /> kelp<br><div id="slider-5"></div> <br>
	  
<input type="checkbox" name="steps[]" id="step4" onclick="return false;" disabled="disabled" /> <b>Land use / cover</b> (current)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="LULC[]" id="developed"  onclick="return false;" disabled="disabled" /> developed&nbsp; <input type="checkbox" name="LULC[]" id="ag"  onclick="return false;" disabled="disabled" /> ag&nbsp; <input type="checkbox" name="LULC[]" id="open"  onclick="return false;" disabled="disabled" /> park/open space&nbsp; <input type="checkbox" name="LULC[]" id="other"  onclick="return false;" disabled="disabled" /> other<br>

<input type="checkbox" name="steps[]" id="step5" /> <b>Zoning</b> (future)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="zoning[]" id="1" checked /> ag&nbsp; <input type="checkbox" name="zoning[]" id="2" checked /> park/open&nbsp; <input type="checkbox" name="zoning[]" id="3" /> res&nbsp; <input type="checkbox" name="zoning[]" id="4" /> comm/ind&nbsp; <input type="checkbox" name="zoning[]" id="5" /> other<br>

</ul> 
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#map" class="button blue" onclick="showCVI();">&nbsp;&nbsp;SHOW ME&nbsp;&nbsp;</a>&nbsp;&nbsp;<a href="#test1" class="button tomato" onclick="clearLayers();">&nbsp;&nbsp;CLEAR (X)&nbsp;&nbsp;</a>
</td>
</tr>
</table>
</fieldset>


<div id='map'></div>
<br>
<table>
<tr><td>
<div id='test1a'></div><h4><u>STEP 3</u>:<br>POTENTIAL ADAPTATION OPTIONS</h4>

<fieldset>
<ul>
<input type="checkbox" name="steps[]" id="step6a"> <b>Dune Restoration</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="duneresto[]" id="dune" checked /> low or high dune<br>

<input type="checkbox" name="steps[]" id="step6b"> <b>Conservation Easement</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="cons_ease[]" id="ce_ag" checked /> ag&nbsp; <input type="checkbox" name="cons_ease[]" id="ce_os" checked /> open space&nbsp; <input type="checkbox" name="cons_ease[]" id="3"  onclick="return false;" disabled="disabled" /> undeveloped<br>

<input type="checkbox" name="steps[]" id="step6c"> <b>No Build Areas</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="no_build[]" id="nb_he" checked /> high exposure&nbsp;<input type="checkbox" name="no_build[]" id="nb_ag" checked /> ag&nbsp; <input type="checkbox" name="no_build[]" id="nb_os" checked /> open space&nbsp; <input type="checkbox" name="nobuild[]" id="undev"   onclick="return false;" disabled="disabled" /> undeveloped<br>

<input type="checkbox" name="steps[]" id="step6d"> <b>Beach Nourishment</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="beachnour[]" id="beach" checked /> sandy beach<br>
</ul>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#map" class="button blue" onclick="showAdaptation();">&nbsp;&nbsp;SHOW ME&nbsp;&nbsp;</a>&nbsp;&nbsp;<a href="#test1" class="button tomato" onclick="clearAdaptation();">&nbsp;&nbsp;CLEAR (X)&nbsp;&nbsp;</a>
</fieldset>
</td></tr>
</table>

<ul>
<br>
<div id="test2a"></div> <!--table 1-->
<p></p>
<div id="test2b"></div> <!--table 2-->
<p></p>
<div id="test2c"></div> <!--table 3-->
<p></p>
<div id="test3"></div> <!--references-->

<br>
<script>

// define basemaps
var ESRIImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri'});

var ESRIOcean = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri'});

var MapboxStreets = L.tileLayer('http://a.tiles.mapbox.com/v3/geointerest.afb8c76d/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://www.mapbox.com">Mapbox</a>'});

var MapboxTerrain = L.tileLayer('http://a.tiles.mapbox.com/v3/geointerest.e4qjes5f/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZ2VvaW50ZXJlc3QiLCJhIjoiQ2czbnlDMCJ9.pQ-_LxzHCL6WqMm5rJrEWw', {attribution: '&copy; <a href="http://www.mapbox.com">Mapbox</a>'});

// map settings
L.mapbox.accessToken = 'pk.eyJ1IjoiZ2VvaW50ZXJlc3QiLCJhIjoiQ2czbnlDMCJ9.pQ-_LxzHCL6WqMm5rJrEWw';
bounds = new L.LatLngBounds(new L.LatLng(44.894791, -131.462357), new L.LatLng(30.562098, -105.965737));

// set base map and controls
var map = new L.Map('map', {
  zoomControl: true,
  layer_selector: false,
  layers: [MapboxTerrain],
  center: [37.25, -120],
  zoom: 6,
  minZoom: 5,
  maxZoom: 13,
  maxBounds: bounds
});

// scale
L.control.scale({ position: 'bottomright' }).addTo(map);


// intersect CV_1km with LeafletDraw
cartodb.createLayer(map, 'https://ehartge.carto.com/api/v2/viz/c0b4ff22-b9c1-11e6-afe4-0e233c30368f/viz.json')
	 .on('done', function(layer) {
		layer.setZIndex(13);	
		// keep track of all draw objects
		var drawnItems = new L.FeatureGroup();
		map.addLayer(drawnItems);

		// set the title to show on the polygon button
		map.on('draw:created', function (e) {
		var type = e.layerType,
		draw_layer = e.layer;

		// show the polygon on the map
		drawnItems.addLayer(draw_layer);

		// get the coordinates of the polygon we just drew
		var poly = draw_layer.getLatLngs();
		var sql_poly = [];
		for (i in poly){
			sql_poly.push("CDB_LatLng("+poly[i].lat+","+poly[i].lng+")")
			}
			// SQL polygon must be a CLOSED loop
			sql_poly.push("CDB_LatLng("+poly[0].lat+","+poly[0].lng+")")

			// join drawn coordinates and a SQL query
			var query = "SELECT * FROM cv_1km_line WHERE ST_Intersects(the_geom, ST_MakePolygon(ST_MakeLine(Array["+sql_poly.join()+"])))";
			
			// run function to update SQL and Style
			updateLayer(query, layer.getSubLayer(0))
		});
})
        .on('error', function(err) {
          alert("some error occurred: " + err);
        });


// add CartoDB vector	
var layerUrlCV = 'https://ehartge.carto.com/api/v2/viz/c0b4ff22-b9c1-11e6-afe4-0e233c30368f/viz.json';	
var layerUrlPts = 'https://ehartge.carto.com/api/v2/viz/d553bce8-b9c1-11e6-9120-0e3ff518bd15/viz.json';	
var habitats = 'https://ehartge.carto.com/api/v2/viz/e440c64e-1658-11e7-a540-0e3ebc282e83/viz.json'; 
var zoning = 'https://ehartge.carto.com/api/v2/viz/ffd85db4-1431-11e7-a573-0e233c30368f/viz.json'; 
var linkages = 'https://ehartge.carto.com/api/v2/viz/8859e1d8-167d-11e7-98f7-0ee66e2c9693/viz.json'; 
var armoring = 'https://natcap.cartodb.com/api/v2/viz/1407c7b2-97a5-11e5-976f-0ecfd53eb7d3/viz.json';


/*
https://ehartge.carto.com/viz/c0b4ff22-b9c1-11e6-afe4-0e233c30368f/public_map
*/

var sql = cartodb.SQL({ user: 'ehartge' });

// add cartoDB layer and set z-index so it shows up on top
cartodb.createLayer(map, 'https://ehartge.carto.com/api/v2/viz/12909494-ba4b-11e6-b3a1-0e3ff518bd15/viz.json')
		.addTo(map)
        .on('done', function(layer) {
		layer.setZIndex(20);	
});


// set base style of grid
function style(feature) {
  return {
	weight: 1,
	fillOpacity: .2,
	fillColor: '#ffff99',
	color:'#de2d26' 
  };
}

// set hover colors
function highlightFeature(e) {
	var layer = e.target;
	layer.setStyle({
		weight: 9,
		opacity: 0.45,
		color: '#ffff99', 
		dashArray: '3',
		fillOpacity: 0.2,
		fillColor: '#fff'
	});
}

// a function to reset the colors when a neighborhood is not longer 'hovered'
function resetHighlight(e) {
	geojson.resetStyle(e.target);
}

// tell MapBox.js what functions to call when mousing over and out of a neighborhood
// add vector data to map
geojson = L.geoJson(grid, {
	style: style,
	onEachFeature: function (feature, layer) {
	layer.on({
	mouseover: highlightFeature,
	mouseout: resetHighlight
	});
			/*<img src=\'img/gallery_sm.png\'>*/
		layer.bindPopup("COUNTY: &nbsp;<b>"+feature.properties.NAME10+"</b><br>DISTRICT: &nbsp;<b>"+feature.properties.DISTRICT+"</b><center><br> COASTAL RECORDS PROJECT<a href=\'http://www.californiacoastline.org/cgi-bin/location.cgi?latdeg="+feature.properties.LAT+"&longdeg="+feature.properties.LONG+"&mode=sequential\' target=\'_blank\'><br><b>AERIAL PHOTO</b></a> || <a href=\'http://www.instantstreetview.com/s/"+feature.properties.LAT+","+feature.properties.LONG+"&mode=sequential\' target=\'_blank\'><b>STREET VIEW</b></a></center>");
	  }
	});


	
function openMarkerPopup(id){
	geojson.eachLayer(function(feature){
		if(feature.feature.properties.id==id){
			feature.openPopup();
		}
	});
}    
map.closePopup();
map.scrollWheelZoom.disable();

// draw control (Leaflet)
L.drawLocal.draw.toolbar.buttons.polygon = 'Draw a polygon';
	var drawControl = new L.Control.Draw({
		position: 'bottomright',
		draw: {
			polyline: false,
			polygon:false,
			rectangle: {
            shapeOptions: {
				color: '#fff',
                clickable: false,
				opacity: 0.1,
            }
        },
			circle: false,
			marker: false
		}
	});
	
		
// map.attributionControl.setPrefix('Map viewer by: <a href="mailto:gverutes@gmail.com" target="_top">Gregg Verutes</a>');
map.addControl(drawControl);	

// add basemap and overlays
var baseMaps = {
	"ocean": ESRIOcean,
	"imagery": ESRIImagery,
	"streets": MapboxStreets,
	"terrain": MapboxTerrain,
};


// add cartoDB layer and set z-index so it shows up on top
	cartodb.createLayer(map, armoring)
	.on('done', function(layer) {
		layer.setZIndex(100);
		var overlayMaps = {	 
		"armoring": layer,
		"aerial photos": geojson,
		//"zoning": zoning,
		};
		L.control.layers(baseMaps, overlayMaps, {position: 'topright', collapsed: true}).addTo(map);
	});

	
// mini map
	// overlay detailed urban place names on locator map using Mapbox Studio
  	var mapboxUrl='http://a.tiles.mapbox.com/v3/mapbox.world-light/{z}/{x}/{y}.png';
	var mb = new L.TileLayer(mapboxUrl, {minZoom: 2, maxZoom: 16});
	var miniMap = new L.Control.MiniMap(mb, { toggleDisplay: true, position: 'bottomleft' }).addTo(map);     


	
/*

	// add legend
	var info = L.control({position: 'bottomright'});
	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
		this.update();
		return this._div;
	};
	info.update = function (props) {
		this._div.innerHTML = "<img src='img/legend.png'>";
	};
	info.addTo(map);
*/



//////////////////////////////////////////

	var count = 0;
  $( "#slider-5" ).slider({
  	change: function(event, ui) { alert(ui.value);} ,
	   orientation: "horizontal",
	   value: 50,
	   step:25,
	   min: 25,
       max: 75,
	   slide: function( event, ui ){
		$( "#minval" ).val( ui.value );
	   }	
	});
	$( "#minval" ).val( $( "#slider-5" ).slider( "value" ) );

/*
// JQuery initialize map and HTML
jQuery(document).ready(function($) {


	// bjqs slider
  $('#banner-slide').bjqs({
    animtype      : 'slide',
    height        : 243,
    width         : 437,
    responsive    : true,
    randomstart   : false,

	animtype        : 'fade',
	animduration    : 350,      // length of transition
	animspeed       : 10000,     // delay between transitions
	automatic       : true,     // enable/disable automatic slide rotation

	// control and marker configuration
	showcontrols    : true,     // enable/disable next + previous UI elements
	centercontrols  : true,     // vertically center controls
	nexttext        : '>>',   // text/html inside next UI element
	prevtext        : '<<',   // text/html inside previous UI element
	showmarkers     : true,     // enable/disable individual slide UI markers
	centermarkers   : true,     // horizontally center markers

	});
});
*/

$("#coasts").change(function(event){
	if ($( "#coasts option:selected" ).text() == 'Sonoma'){
	map.setView([38.55, -123.1], 9);
	showMapTable(1);
	}
	
	else if ($( "#coasts option:selected" ).text() == 'Marin'){
	map.setView([38.05, -123], 9);
	showMapTable(2);
	}  	
	
	else if ($( "#coasts option:selected" ).text() == 'Santa Cruz - Monterey'){
	map.setView([36.8, -122], 10);
	showMapTable(3);
	}
	
	else{
	map.setView([37.25, -121.5], 6);	
	eraseTable("test2a");eraseTable("test2b");eraseTable("test2c");eraseTable("test2d");	
	}
});

//////////////////////////////////////////

// initialize CARTO account
var sql = cartodb.SQL({ user: 'gverutes' });

// zoom Chapter
function zoomZip(){	

	var ZipQuery = "SELECT * FROM us_zipcodes WHERE zip_code = "+document.getElementsByName('zipcode')[0].value;

	sql.getBounds(ZipQuery).done(function(bounds) {
	map.fitBounds(bounds);

	var popup = L.popup()
		.setLatLng([((bounds[0][0]+bounds[1][0])/2),((bounds[0][1]+bounds[1][1])/2)])
		.setContent(document.getElementsByName('zipcode')[0].value)
		.openOn(map);
	
	});
}


function handle(e){
        if(e.keyCode === 13){
            e.preventDefault(); // ensure it is only this code that runs

            if (document.getElementsByName('zipcode')[0].value != 'Type Zip Code + Enter...'){zoomZip();}
        }
    }

//////////////////////////////////////////

// add commas to numbers > 1000
function numberWithCommas(x) {
	return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}	


// clear zipcode
function clearZip(){
	document.getElementById("zipcode").value= "";
}


function showRef1(url){

var HTML3 = '';

HTML3 = HTML3 + "<br><table id='table04'><tbody><tr><td bgcolor='#000'><font color='white'><b>&nbsp;&nbsp;Langridge et al., 2014; Ocean & Coastal Management</b></font></td><td bgcolor='#000'><div align='right'><a href='#test1' class='button' onclick='eraseTable(\"test3\");'>X</a></div></td></tr><tr><tr><td colspan='2'><center><iframe src='"+url+"' width='1100' height='500'></iframe></center></td></tr></table>";

document.getElementById("test3").innerHTML = HTML3;

}

function showRef2(url){

var HTML3 = '';

HTML3 = HTML3 + "<br><table id='table04'><tbody><tr><td bgcolor='#000'><font color='white'><b>&nbsp;&nbsp;Santa Cruz Integrated Regional Water Management Plan - 2014</b></font></td><td bgcolor='#000'><div align='right'><a href='#test1' class='button' onclick='eraseTable(\"test3\");'>X</a></div></td></tr><tr><tr><td colspan='2'><center><iframe src='"+url+"' width='1100' height='500'></iframe></center></td></tr></table>";

document.getElementById("test3").innerHTML = HTML3;

}

function showRef3(url){

var HTML3 = '';

HTML3 = HTML3 + "<br><table id='table04'><tbody><tr><td bgcolor='#000'><font color='white'><b>&nbsp;&nbsp;Greater Monterey County Integrated Regional Water Management Plan</b></font></td><td bgcolor='#000'><div align='right'><a href='#test1' class='button' onclick='eraseTable(\"test3\");'>X</a></div></td></tr><tr><tr><td colspan='2'><center><iframe src='"+url+"' width='1100' height='500'></iframe></center></td></tr></table>";

document.getElementById("test3").innerHTML = HTML3;

}



function showMapTable(site_num){
	
	///////////////////////////////////////////////////////////////////////////////
	// Sonoma County

	if (site_num == 1){
	
		var HTML2a = "<h5>Sonoma County, California</h5><p></p><table id='table03b'><tbody>";
		
		HTML2a = HTML2a + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Strategies</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><ul><li>xxx</li><li>xxx</li><li>xxx</li></ul></td><td><b>Legal variables</b><ul><li>xxx</li></ul></td><td>&nbsp;&nbsp&nbsp;&nbsp;<b>Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test4'><img src='img/scorecard_icon.png' width='33px' height='33px' title='surveys'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/stewardship.png' title='interviews'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test5'><img src='img/gallery.png' title='photos'></a></td></tr></table></td></tr>";

		HTML2a = HTML2a + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Habitat</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><br><ul><li>xxx</li></ul></td><td><b>Species present</b><ul><li>xxx <i>(xxx)</i></li><li>xxx (<i>xxx</i>)</li><li>xxx <i>(xxx)</i></li></ul></td><td><b>&nbsp;&nbsp&nbsp;&nbsp;Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test4'><img src='img/scorecard_icon.png' width='33px' height='33px' title='surveys'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/world_icon.png' title='xxx'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test3');'><img src='img/storymap.png' title='habitat distribution model'></a></td></tr></table></td></tr>";
	
		HTML2a = HTML2a + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Zoning</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><br><ul><li>xxx</li></ul></td><td><b>Social variables</b><ul><li>xxx</li><li>xxx</li><li>xx</li></ul></td><td>&nbsp;&nbsp&nbsp;&nbsp;<b>Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/stewardship.png' title='interviews'></a></td></tr></table></td></tr>";

		HTML2a = HTML2a + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Exposure</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><br><ul><li>NOAA ESI</li><li>Arkema et al. 2013</li></ul></td><td><b>Outputs available</b><ul><li>xxx</li></ul></td><td><b>&nbsp;&nbsp&nbsp;&nbsp;Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/world_icon.png' title='map exposure'></a></td></tr></table></td></tr>";
		
		HTML2a = HTML2a + "</table>";
		
		document.getElementById("test2a").innerHTML = HTML2a;
		eraseTable("test2b");eraseTable("test2c");eraseTable("test2d");
	}
	
	
	///////////////////////////////////////////////////////////////////////////////
	// Marin County

	else if (site_num == 2){
	
		var HTML2b = "<h3>Marin County, California</h3><p></p><table id='table03b'><tbody>";
		
		HTML2b = HTML2b+ "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Strategies</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><ul><li>xxx</li><li>xxx</li><li>xxx</li></ul></td><td><b>Legal variables</b><ul><li>xxx</li></ul></td><td>&nbsp;&nbsp&nbsp;&nbsp;<b>Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test4'><img src='img/scorecard_icon.png' width='33px' height='33px' title='surveys'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/stewardship.png' title='interviews'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test5'><img src='img/gallery.png' title='photos'></a></td></tr></table></td></tr>";

		HTML2b = HTML2b + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Habitat</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><br><ul><li>xxx</li></ul></td><td><b>Species present</b><ul><li>xxx <i>(xxx)</i></li><li>xxx (<i>xxx</i>)</li><li>xxx <i>(xxx)</i></li></ul></td><td><b>&nbsp;&nbsp&nbsp;&nbsp;Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test4'><img src='img/scorecard_icon.png' width='33px' height='33px' title='surveys'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/world_icon.png' title='xxx'></a>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test3');'><img src='img/storymap.png' title='habitat distribution model'></a></td></tr></table></td></tr>";
	
		HTML2b = HTML2b + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Zoning</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><br><ul><li>xxx</li></ul></td><td><b>Social variables</b><ul><li>xxx</li><li>xxx</li><li>xx</li></ul></td><td>&nbsp;&nbsp&nbsp;&nbsp;<b>Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/stewardship.png' title='interviews'></a></td></tr></table></td></tr>";

		HTML2b = HTML2b + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Exposure</h5></tr><tr><td colspan='4'><table id='table02d'><tr><td><b>Sources</b><br><ul><li>NOAA ESI</li><li>Arkema et al. 2013</li></ul></td><td><b>Outputs available</b><ul><li>xxx</li></ul></td><td><b>&nbsp;&nbsp&nbsp;&nbsp;Outputs</b><br>&nbsp;&nbsp&nbsp;&nbsp;<a href='#test1' id='back'><img src='img/world_icon.png' title='map exposure'></a></td></tr></table></td></tr>";
		
		HTML2b = HTML2b + "</table>";
		
		document.getElementById("test2b").innerHTML = HTML2b;
		eraseTable("test2a");eraseTable("test2c");eraseTable("test2d");
	}

	///////////////////////////////////////////////////////////////////////////////
	// SC / M Counties

	else if (site_num == 3){
	
		L.marker([36.7911293,-121.7927123]).addTo(map).bindPopup("Mouth of Old Salinas River");
		L.marker([36.790957,-121.7667936]).addTo(map).bindPopup("Moro Cojo Slough");
		L.marker([36.813504, -121.758772]).addTo(map).bindPopup("Elkhorn Slough");
		L.marker([36.9723457,-121.9548245]).addTo(map).bindPopup("Capitola");
	
		var HTML2c = "<h3>Santa Cruz - Monterey Counties</h3><p></p><table id='table03b'><tbody>";
		
		HTML2c = HTML2c + "<tr><td colspan='3'><b>Summary</b><br><ul><li>The Monterey Bay coastline features <b>diverse coastal habitats</b> including: dense kelp forests; brackish wetland habitats along creeks, lagoons, and sloughs; and expansive beach and dune systems that cover the central and southern sections of the coastline.</li><li>While each coastal habitat plays some protective role, <b>the dune systems</b> in southern Monterey Bay play the highest role in reducing exposure of coastal development to erosion and inundation during storms relative to the entire study area.</li><li>Any climate adaptation strategies under consideration along the Monterey Bay coastline <b>should conform with the strictures of the Coastal Act</b>, consider the recommendations from the Coastal Commissionâ€™s sea level rise guidance, and respect the cultural significance of the region.</li><li>A primary consideration for proactive coastal adaptation is to incentivize proactive climate adaptation planning that utilizes a blend of approaches across multiple timescales; optimal strategies should not limit adaptation options for future generations.</li></ul></td><td><center><img src='img/Capitola.png'><br>Coastal flooding during winter storm<br><i>Capitola, March 2014</i></center></td></tr>";
		
		HTML2c = HTML2c + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>Potential Strategies</h5></tr><tr><td><b>Dune Restoration</b><br>(Mouth of Old Salinas River)</td><td colspan='2'>Existing dune restoration project across from Moss Landing Marine Lab to help protect vital flood gates on Potrero Rd.</td><td>&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;<a href='#map' onclick='zoomPt(36.7911293,-121.7927123,\"Mouth of Old Salinas River\");'><img src='img/world_icon.png' title='map this strategy'></a></td></tr><tr><td><b>Wetland Restoration</b><br>(Moro Cojo Slough)</td><td colspan='2'>Wetlands currently play an important role in flood control and are adjacent to park land which is then backed by high yield agricultural land.</td><td>&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;<a href='#map' onclick='zoomPt(36.790957,-121.7667936,\"Moro Cojo Slough\");'><img src='img/world_icon.png' title='map this strategy'></a></td></tr><tr><td><b>Conservation Easement</b><br>(Elkhorn Slough)</td><td colspan='2'>There are opportunities for larger or new easements as the agricultural land becomes less valuable due to flooding and saltwater intrusion.</td><td>&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;<a href='#map' onclick='zoomPt(36.813504, -121.758772,\"Elkhorn Slough\");'><img src='img/world_icon.png' title='map this strategy'></a></td><tr><td><b>Overlay Zones</b><br>(Capitola)</td><td colspan='2'>The Capitola community could consider including a <i>sea level rise hazard zone</i> that denotes the properties that would have specific redevelopment policies that are more restrictive than in other locations.</td><td>&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;<a href='#map' onclick='zoomPt(36.9723457,-121.9548245,\"Capitola\");'><img src='img/world_icon.png' title='map this strategy'></a></td></tr>";

		HTML2c = HTML2c + "<tr><td colspan='4' bgcolor='#f5f5f5'>&nbsp;&nbsp;<h5>References</h5></tr><tr><td>Greater Monterey County Integrated Regional Water Management Plan: Appendix K</td><td colspan='2'>The Role of Natural Habitat in Coastal Vulnerability and Adaptation Planning within the Greater Monterey Co. Region</td><td>&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;<a href='#test3' onclick='showRef3(\"docs/AppendixK_Habitat_Vulnerability_Adaptation.pdf\");'><img src='img/scorecard_icon.png' width='33px' height='33px' title='view this report'></a></td></tr><tr><td>Langridge et al., 2014;<br>Ocean & Coastal Management</td><td colspan='2'>Key lessons for incorporating natural infrastructure intro regional climate adaptation planning</td><td>&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;<a href='#test3' onclick='showRef1(\"docs/Langridge_etal_2014_OCM.pdf\");'><img src='img/scorecard_icon.png' width='33px' height='33px' title='view this article'></a></td></tr><tr><td>Santa Cruz Integrated Regional Water Management Plan - 2014</td><td colspan='2'>See Adaptation Strategies in<br>Chapter 15: Climate Change</td><td>&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;<a href='#test3' onclick='showRef2(\"docs/SC_IRWMP_ExecSumm_2014.pdf\");'><img src='img/scorecard_icon.png' width='33px' height='33px' title='view this report'></a></td></tr>";
		
		HTML2c = HTML2c + "</table>";
		
		document.getElementById("test2c").innerHTML = HTML2c;
		eraseTable("test2b");eraseTable("test2a");eraseTable("test2d");
	}
	
}

// erase tables using "x" button
function eraseTable(div_id){

document.getElementById(div_id).innerHTML = "";

}

var start = 0;
var end = 0;  
var sublayersCVI = [];

// CVI
function showCVI(){


	var ck_exposure = document.getElementById('step1');
	var ck_habitats = document.getElementById('step2');
	var ck_habrole = document.getElementById('step3');
	var ck_zoning = document.getElementById('step5');
	//if (ck_zoning.checked){zoning.addTo(map);}
	
	
	
	if (ck_exposure.checked){	
		var MapQueryCVI = "SELECT * FROM cv_1km_line";
		var CartoCSSCVI = "#cv_1km_line{line-color: #0080ff;line-width: 3;line-opacity: 1;line-join:round;line-cap: round;line-smooth:0.25;}[zoom=8]{line-width: 4;}[zoom=9]{line-width: 4;}[zoom=10]{line-width: 5;}[zoom=11]{line-width: 5;}[zoom=12]{line-width: 7;}[zoom=13]{line-width: 7;}[zoom=14]{line-width: 8;}[zoom=15]{line-width: 8;}[zoom=16]{line-width: 10;}";

		CartoCSSCVI = CartoCSSCVI + "#cv_1km_line [ coastal_ex <= 5] {line-color: #C00000;}#cv_1km_line [ coastal_ex <= 3.6590500000000001] {line-color: #de2d26;}#cv_1km_line [ coastal_ex <= 3.2951000000000001] {line-color: #FFCC00;}#cv_1km_line [ coastal_ex <= 3.0468299999999999] {line-color: #ffff00;}#cv_1km_line [ coastal_ex <= 2.7981699999999998] {line-color: #528FD4;}"
		
		
		  cartodb.createLayer(map, layerUrlCV)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQueryCVI,
			  cartocss: CartoCSSCVI,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersCVI.push(sublayer);
			layer.setZIndex(20);
		  }).on('error', function() {
			// log the error
		  });
		  
		  
		  var CartoCSSCVI2 = "#cv_1km_line{line-color: #fff;line-width: 8;line-opacity: 0.6;line-join:round;line-cap: round;line-smooth:0.25;}";
		  
		  cartodb.createLayer(map, layerUrlCV)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQueryCVI,
			  cartocss: CartoCSSCVI2,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersCVI.push(sublayer);
			layer.setZIndex(19);
		  }).on('error', function() {
			// log the error
		  });
			end = end + 2;
	}
	  
	if (ck_habrole.checked){
		var MapQueryHabRole = "SELECT * FROM coastal_exposure_pts WHERE habitat_ro > 0.40";
		var CartoCSSHabRole = "#cv_1km_line{marker-fill-opacity:0;marker-width:12;marker-line-color:#000;marker-line-opacity:0.8;}";

		  cartodb.createLayer(map, layerUrlCV)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQueryHabRole,
			  cartocss: CartoCSSHabRole,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersCVI.push(sublayer);
			layer.setZIndex(21);
		  }).on('error', function() {
			// log the error
		  });	  
		  end = end + 1;
	}  

	if (ck_habitats.checked){
		var MapQueryHab = "SELECT * FROM mergehabitats7_ca";
		var CartoCSSHab = "#mergehabitats7_ca {polygon-opacity: 0.9;line-color: #FFF;line-width: 0;line-opacity: 0.9;}#mergehabitats7_ca[type=7] {polygon-fill: #5CA2D1;line-color: #5CA2D1;[zoom>7]{line-width: 1.5;}}#mergehabitats7_ca[type=1] {polygon-fill: #081B47;line-color: #081B47;[zoom>7]{line-width: 2;}}#mergehabitats7_ca[type=2] {polygon-fill: #B81609;line-color: #B81609;[zoom>7]{line-width: 2;}}#mergehabitats7_ca[type=3] {polygon-fill: #FF9900;line-color: #FF9900;[zoom>7]{line-width: 2;}}#mergehabitats7_ca[type=4] {polygon-fill: #00ff96;line-color: #00ff96;[zoom>7]{line-width: 2;}}#mergehabitats7_ca[type=5] {polygon-fill: #136400;line-color:  #136400;[zoom>7]{line-width: 1;}}#mergehabitats7_ca[type=6] {polygon-fill: #229A00;line-color: #229A00;[zoom>7]{line-width: 0.5;}}";
		
		
		  cartodb.createLayer(map, habitats)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sqlHab: MapQueryHab,
			  cartocss: CartoCSSHab,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersCVI.push(sublayer);
			layer.setZIndex(19);
		  }).on('error', function() {
			// log the error
		  });
			end = end + 1;
	}


	if (ck_zoning.checked){
	
		// find list of checked boxes
		var checkedZoningList = [];	
		var chk = document.getElementsByName('zoning[]')
		var len = chk.length

		// push text to list
		
		for(i=0;i<len;i++){
			if(chk[i].checked){
				checkedZoningList.push(i+1);
			}
		}
		
		var MapQueryZoning = "SELECT * FROM zoning_march2017";	
		
		if (checkedZoningList.length > 0){

			MapQueryZoning = MapQueryZoning + " WHERE zone_id = "+checkedZoningList[0];
			for(i=1;i<checkedZoningList.length;i++){
				MapQueryZoning = MapQueryZoning + " OR zone_id = "+checkedZoningList[i];
			}
		}
		
		var CartoCSSZoning = "#zoning_march2017 {polygon-opacity: 1;line-color: #FFF;line-width:0;line-opacity:0;}#zoning_march2017[zone_id=1] {polygon-fill: #D2691E;}#zoning_march2017[zone_id=4] {polygon-fill: #081B47;}#zoning_march2017[zone_id=2] {polygon-fill: #a1d99b;}#zoning_march2017[zone_id=3] {polygon-fill: #d3d3d3;}#zoning_march2017[zone_id=5] {polygon-fill: #FFFFFF;}";
		
		  cartodb.createLayer(map, zoning)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQueryZoning,
			  cartocss: CartoCSSZoning,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersCVI.push(sublayer);
			layer.setZIndex(16);
		  }).on('error', function() {
			// log the error
		  });
			end = end + 1;
	}

	
}

// CLEAR LAYERS
function clearLayers(){

	for (var i = start; i < end; i++) {
		sublayersCVI[i].remove();
		}
	start = end;
}


//////////////////////////////////////////////
/////////////////////////////////////////////


var startAO = 0;
var endAO = 0;  
var sublayersAO = [];

// Adaptation Options
function showAdaptation(){

	var ck_dune_resto = document.getElementById('step6a');
	var ck_cons_ease = document.getElementById('step6b');
	var ck_no_build = document.getElementById('step6c');
	var ck_beach_nour = document.getElementById('step6d');


	
	if (ck_dune_resto.checked){

		var MapQuery6a = "SELECT * FROM cv_1km_link_scmb WHERE hab_dune = 1";	
		
		var CartoCSS6a = "#cv_1km_link_scmb{marker-line-width: 1;marker-line-color:#000; marker-line-opacity: 0;marker-fill: #000; marker-fill-opacity: 0.5; marker-width: 15; marker-allow-overlap: true;}";
		
		  cartodb.createLayer(map, linkages)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQuery6a,
			  cartocss: CartoCSS6a,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersAO.push(sublayer);
			layer.setZIndex(25);
		  }).on('error', function() {
			// log the error
		  });
			endAO = endAO + 1;
	}		
	
	
	if (ck_cons_ease.checked){

		var ck_ce_ag = document.getElementById('ce_ag');
		var ck_ce_os = document.getElementById('ce_os');
		
		var MapQuery6b = "SELECT * FROM cv_1km_link_scmb";	
		if (ck_ce_ag.checked && ck_ce_os.checked){MapQuery6b = MapQuery6b + " WHERE zone_ag = 1 OR zone_open = 1";}
		else if (ck_ce_ag.checked){MapQuery6b = MapQuery6b + " WHERE zone_ag = 1";}
		else if (ck_ce_os.checked){MapQuery6b = MapQuery6b + " WHERE zone_open = 1";}
		
		var CartoCSS6b = "#cv_1km_link_scmb{marker-line-width: 1;marker-line-color:#000; marker-line-opacity: 0;marker-fill: #000; marker-fill-opacity: 0.5; marker-width: 15; marker-allow-overlap: true;}";
		
		  cartodb.createLayer(map, linkages)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQuery6b,
			  cartocss: CartoCSS6b,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersAO.push(sublayer);
			layer.setZIndex(25);
		  }).on('error', function() {
			// log the error
		  });
			endAO = endAO + 1;
	}	


	if (ck_no_build.checked){

		var ck_nb_he = document.getElementById('nb_he');	
		var ck_nb_ag = document.getElementById('nb_ag');
		var ck_nb_os = document.getElementById('nb_os');
		
		var MapQuery6c = "SELECT * FROM cv_1km_link_scmb";	
		
		if (ck_nb_he.checked && ck_nb_ag.checked && ck_nb_os.checked){
			MapQuery6c = MapQuery6c + " WHERE coastal_ex >= 3.6 AND (zone_ag = 1 OR zone_open = 1)";
		}
		else if (ck_nb_he.checked && ck_nb_ag.checked){MapQuery6c = MapQuery6c + " WHERE coastal_ex >= 3.6 AND zone_ag = 1";} 
		else if (ck_nb_he.checked && ck_nb_os.checked){MapQuery6c = MapQuery6c + " WHERE coastal_ex >= 3.6 AND zone_open = 1";} 
		else if (ck_nb_ag.checked && ck_nb_os.checked){MapQuery6c = MapQuery6c + " WHERE zone_ag = 1 OR zone_open = 1";}
		
		else if (ck_nb_he.checked){MapQuery6c = MapQuery6c + " WHERE coastal_ex >= 3.6";} 
		else if (ck_nb_ag.checked){MapQuery6c = MapQuery6c + " WHERE zone_ag = 1";}
		else if (ck_nb_os.checked){MapQuery6c = MapQuery6c + " WHERE zone_open = 1";}
		
		var CartoCSS6c = "#cv_1km_link_scmb{marker-line-width: 1;marker-line-color:#000; marker-line-opacity: 0;marker-fill: #000; marker-fill-opacity: 0.5; marker-width: 15; marker-allow-overlap: true;}";
		
		  cartodb.createLayer(map, linkages)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQuery6c,
			  cartocss: CartoCSS6c,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersAO.push(sublayer);
			layer.setZIndex(25);
		  }).on('error', function() {
			// log the error
		  });
			endAO = endAO + 1;
	}	

	
	
	if (ck_beach_nour.checked){

		var MapQuery6d = "SELECT * FROM cv_1km_link_scmb WHERE geom_beach = 1";	
		
		var CartoCSS6d = "#cv_1km_link_scmb{marker-line-width: 1;marker-line-color:#000; marker-line-opacity: 0;marker-fill: #000; marker-fill-opacity: 0.5; marker-width: 15; marker-allow-overlap: true;}";
		
		  cartodb.createLayer(map, linkages)
		  .addTo(map)
		  .on('done', function(layer) {
			// change the query for the first layer
			var subLayerOptions = {
			  sql: MapQuery6d,
			  cartocss: CartoCSS6d,
			}
			var sublayer = layer.getSubLayer(0);
			sublayer.set(subLayerOptions);
			sublayersAO.push(sublayer);
			layer.setZIndex(25);
		  }).on('error', function() {
			// log the error
		  });
			endAO = endAO + 1;
	}

	
}


// CLEAR LAYERS
function clearAdaptation(){

	for (var i = startAO; i < endAO; i++) {
		sublayersAO[i].remove();
		}
	startAO = endAO;
}





// add commas to numbers > 1000
function numberWithCommas(x) {
	return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}	

// round to two hundredths
function roundToTwo(value) {
	return(Math.round(value * 100) / 100);
}

// draw bar chart
google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(drawBarChart);

function drawBarChart(buildBar, arr1, arr2, arr3, arr4, arr5) {
var data = google.visualization.arrayToDataTable([
['Variable Rank', '1', '2', '3', '4', '5'],
['Waves',   arr1[0]/4, arr2[0]/4, arr3[0]/4, arr4[0]/4, arr5[0]/4],
['Elevation',   arr1[1]/4, arr2[1]/4, arr3[1]/4, arr4[1]/4, arr5[1]/4],
['Surge',  arr1[2]/4, arr2[2]/4, arr3[2]/4, arr4[2]/4, arr5[2]/4],
['Geomph',  arr1[3]/4, arr2[3]/4, arr3[3]/4, arr4[3]/4, arr5[3]/4],
//['SLR',  arr1[4]/4, arr2[4]/4, arr3[4]/4, arr4[4]/4, arr5[4]/4],
//['Habitats',  arr1[5]/4, arr2[5]/4, arr3[5]/4, arr4[5]/4, arr5[5]/4],
]);

var options = {
title: 'Variable Ranks of Selected Coast',
colors: ['#f0f0f0', '#f0f0f0', '#d9d9d9', '#525252', '#000'],
is3D:true,
isStacked: true,
};

var chart = new google.visualization.BarChart(buildBar);
chart.draw(data, options);
}
		

// Leaflet popup
function popup(lat, lon, type){
	var popup = L.popup()
	.setLatLng([lat, lon])
	.setContent('your selection')
	.openOn(map);
	} 	

// Leaflet popup
function zoomPt(lat, lon, name){	

	map.setView([lat, lon], 13);

	var popup = L.popup()
		.setLatLng([lat, lon])
		.setContent(name)
		.openOn(map);
	}
	
	
// intersect Leaflet draw and write table
function updateLayer(query, layer){
	// switch to last tab
	//$("#tabs").tabs({ active: 1}); 
	
	// run a query to select portions of a layer
	var sql = cartodb.SQL({ user: 'ehartge' });

	sql.execute("SELECT * FROM ("+query+") a").done(function(data) {
	var arr1 = [4, 4, 4, 4, 4, 4];
	var arr2 = [4, 4, 4, 4, 4, 4];
	var arr3 = [4, 4, 4, 4, 4, 4];
	var arr4 = [4, 4, 4, 4, 4, 4];
	var arr5 = [4, 4, 4, 4, 4, 4];
	
	for (var i = 0; i < data.total_rows; i++) {
		
		switch(data.rows[i].wave_expos) {
			case (3):
				arr3[0] = arr3[0] + 1;
				break;
			case (4):
				arr4[0] = arr4[0] + 1;
				break;
			case (5):
				arr5[0] = arr5[0] + 1;
				break;
			case (2):
				arr2[0] = arr2[0] + 1;
				break;
			case (1):
				arr1[0] = arr1[0] + 1;
				break;
		}
		
		switch(data.rows[i].relief) {
			case (3):
				arr3[1] = arr3[1] + 1;
				break;
			case (4):
				arr4[1] = arr4[1] + 1;
				break;
			case (5):
				arr5[1] = arr5[1] + 1;
				break;
			case (2):
				arr2[1] = arr2[1] + 1;
				break;
			case (1):
				arr1[1] = arr1[1] + 1;
				break;
		}
	
		switch(data.rows[i].surge_pote) {
			case (3):
				arr3[2] = arr3[2] + 1;
				break;
			case (4):
				arr4[2] = arr4[2] + 1;
				break;
			case (5):
				arr5[2] = arr5[2] + 1;
				break;
			case (2):
				arr2[2] = arr2[2] + 1;
				break;
			case (1):
				arr1[2] = arr1[2] + 1;
				break;
		}

		switch(data.rows[i].geomorphol) {
			case (3):
				arr3[3] = arr3[3] + 1;
				break;
			case (4):
				arr4[3] = arr4[3] + 1;
				break;
			case (5):
				arr5[3] = arr5[3] + 1;
				break;
			case (2):
				arr2[3] = arr2[3] + 1;
				break;
			case (1):
				arr1[3] = arr1[3] + 1;
				break;
		}	

		
	drawBarChart(document.getElementById('chartBar_div'), arr1, arr2, arr3, arr4, arr5);
	
	}
})
}
</script>	
</div>
</body>
</html>